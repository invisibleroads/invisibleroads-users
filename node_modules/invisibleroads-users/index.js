(function() {

  var users = IR.users;
  var csrf_token = users.csrf_token;
  var user_id = users.user_id;
  var $enter_button = $('button.users-enter');

  if (user_id) {

    // Send CSRF token automatically for AJAX requests
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (/^(POST|PATCH|DELETE|PUT)$/.test(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader('X-CSRF-Token', csrf_token);
        }
      }
    });

    // Send CSRF token automatically for form requests
    $('form').submit(function() {
      var $form = $(this), url_parser = document.createElement('a');
      // Get source_host
      var source_host = location.host;
      // Get target_host
      url_parser.href = $form.prop('action');
      var target_host = url_parser.host;
      // Do not append csrf_token for cross-domain requests
      if (target_host != source_host) return;
      // Check whether it already exists
      if ($form.find('[name=csrf_token]').length) return;
      // Append csrf_token
      $form.append($('<input>', {
        name: 'csrf_token',
        value: csrf_token,
        type: 'hidden'
      }));
    });

  }

  $('.users-enter').mouseenter(function() {
    $enter_button.addClass('btn-primary').removeClass('btn-default');
  }).mouseleave(function() {
    $enter_button.addClass('btn-default').removeClass('btn-primary');
  }).click(function() {
    $('#auth-modal').modal('show');
  });

  $('.users-leave').click(function() {
    location.href = users.leave_url + '?target_url=' + users.target_url;
  });

  $('.btn-auth').css(
    'background-image', 'url(' + users.assets_url + 'btn-auth.png)'
  ).click(function() {
    location.href = $(this).attr('href') + '?target_url=' + users.target_url;
    return false;
  });

}());

function show_feedback(title, body) {
  // Hide other modals
  $('.modal').modal('hide');
  // Render feedback modal
  var $modal = $('#feedback-modal');
  $modal.find('.modal-title').html(title);
  $modal.find('.modal-body').html(body);
  return $modal.modal('show');
}
