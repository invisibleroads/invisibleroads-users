require('invisibleroads-posts');
// Redirect to login if the page is forbidden
$(document).ajaxError(function(event, request, settings) {
  if (!d.users.user_id && request.status == 403) {
    window.location = d.users.login_url;
  }
});
if (d.users.user_id) {
  // Send CSRF token automatically for AJAX requests
  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
      if (/^(POST|PUT|DELETE)$/.test(settings.type) && !this.crossDomain) {
        xhr.setRequestHeader('X-CSRF-Token', d.users.csrf_token);
      }
    }
  });
  // Send CSRF token automatically for form requests
  $('form').submit(function() {
    var $form = $(this), url_parser = document.createElement('a');
    // Get source_host
    var source_host = window.location.host;
    // Get target_host
    url_parser.href = $form.prop('action');
    var target_host = url_parser.host;
    // Do not append csrf_token for cross-domain requests
    if (target_host != source_host) return;
    // Append csrf_token
    $form.append($('<input>', {
      'name': 'csrf_token',
      'value': d.users.csrf_token,
      'type': 'hidden'
    }));
  });
  // Clear session storage on logout
  $('#login-form').submit(function() {
    sessionStorage.clear();
  });
}
